# Wave 2: Core Features
## Objectives
1. **Core data models and database schema**: Define schemas for users, listening history, tracks, artists, albums; indexes for performance; relationships and constraints.
2. **REST API endpoints**: CRUD endpoints for listening history, track/artist metadata, user profiles; authentication; error handling and validation.
3. **Data import pipeline**: Batch import from Spotify, Apple Music, YouTube Music; parsing and normalization; background processing with job queues.
## Tasks
1. **Database schema design**: Create schemas for all core entities
   - Design user table with profile fields and privacy settings (`users` table)
   - Design listening history table with track/artist/album references (`listening_history` table)
   - Design track, artist, album metadata tables (`tracks`, `artists`, `albums` tables)
   - Add indexes on frequently queried fields (user_id, timestamp, track_id, artist_id)
   - Set up foreign key constraints and cascading rules
   - Add database migration files (`/database/migrations/`)
2. **User authentication service**: Implement authentication and authorization
   - Create user registration endpoint (`POST /api/v1/auth/register`)
   - Create login endpoint with JWT tokens (`POST /api/v1/auth/login`)
   - Create token refresh endpoint (`POST /api/v1/auth/refresh`)
   - Implement password hashing (bcrypt)
   - Add middleware for protected routes (`/middleware/auth.ts`)
   - Create user profile endpoints (`GET/PUT /api/v1/users/:id`)
3. **Listening history CRUD endpoints**: Core operations for listening data
   - Create listening record endpoint (`POST /api/v1/listening-history`)
   - Batch create endpoint for imports (`POST /api/v1/listening-history/batch`)
   - Get user's listening history with pagination (`GET /api/v1/listening-history`)
   - Update listening record (`PUT /api/v1/listening-history/:id`)
   - Delete listening record (`DELETE /api/v1/listening-history/:id`)
   - Implement query filters (date range, artist, track)
4. **Music metadata endpoints**: Track/artist/album operations
   - Get track details endpoint (`GET /api/v1/tracks/:id`)
   - Get artist details with discography (`GET /api/v1/artists/:id`)
   - Get album details with tracks (`GET /api/v1/albums/:id`)
   - Search tracks/artists/albums (`GET /api/v1/search?q=query&type=track`)
   - Create/update metadata endpoints (`POST/PUT /api/v1/tracks`, `/artists`, `/albums`)
5. **Data import service setup**: Infrastructure for batch imports
   - Create import job queue system (Bull/Redis)
   - Design import job schema (status, source, progress, error tracking)
   - Create import service interface (`/services/import/ImportService.ts`)
   - Implement job status tracking endpoint (`GET /api/v1/imports/:id`)
   - Add import history table (`import_jobs` table)
6. **Database connection and pooling**: Optimize database access
   - Configure connection pooling (pg-pool for PostgreSQL)
   - Set up connection pool settings (min/max connections, timeout)
   - Implement read replica support (`/database/replica.ts`)
   - Add query logging and monitoring
   - Create database health check endpoint (`GET /api/v1/health/db`)
7. **Caching layer implementation**: Redis caching for performance
   - Set up Redis connection (`/services/cache/RedisService.ts`)
   - Implement cache for frequently accessed data (user profiles, popular tracks)
   - Add cache invalidation strategies
   - Create cache middleware for API responses (`/middleware/cache.ts`)
   - Implement session storage in Redis
8. **API error handling and validation**: Consistent error responses
   - Create error response format (`/utils/errors.ts`)
   - Implement request validation middleware (Zod/Joi)
   - Add error logging (Winston/Pino)
   - Create API documentation (OpenAPI/Swagger)
   - Add rate limiting middleware (`/middleware/rateLimit.ts`)
## Dependencies
- Wave 1 must be complete (project setup, base infrastructure)
- PostgreSQL database instance running
- Redis instance for caching and job queues
- External music metadata APIs (Spotify, Apple Music, YouTube Music) for reference
## Acceptance Criteria
- [ ] Database schema deployed with indexes; foreign keys configured
- [ ] User registration and login endpoints return JWT tokens; protected routes validate tokens
- [ ] Listening history CRUD endpoints handle create, read, update, delete with pagination (100 records per page)
- [ ] Import job system processes batch imports; jobs track status and progress
- [ ] All API endpoints return consistent error responses (status codes, message format)
- [ ] Database connection pooling configured; health check endpoint reports connection status
- [ ] Redis caching reduces database queries by at least 40% for frequently accessed endpoints
---
*Generated by Foundation Framework Phase 1*
